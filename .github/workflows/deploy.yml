name: CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: '22.x'
  AWS_REGION: 'us-east-1'

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint code
        run: npm run lint
        
      - name: Run security audit
        run: npm audit --audit-level=high
        continue-on-error: true
        
      - name: Check for outdated dependencies
        run: npm outdated || true
      
  build:
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create version file
        run: |
          mkdir -p dist
          echo "{\n  \"version\": \"${GITHUB_SHA:0:7}\",\n  \"buildDate\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\",\n  \"buildNumber\": \"$GITHUB_RUN_NUMBER\",\n  \"branch\": \"${GITHUB_REF#refs/heads/}\"\n}" > version.json

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Copy version file to dist
        run: cp version.json dist/

      - name: Prepare Lambda deployment package
        run: |
          # Create a new directory for Lambda package
          mkdir -p lambda-package
          # Copy necessary files
          cp -r dist/* lambda-package/
          cp package.json lambda-package/
          cp version.json lambda-package/
          # Install production dependencies
          cd lambda-package
          npm ci --omit=dev
          # Create deployment package
          zip -r ../function.zip .
          cd ..

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package
          path: function.zip

  deploy:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-package

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create Lambda function
        run: |
          # Create Lambda function if it doesn't exist
          aws lambda create-function \
            --function-name lukbot \
            --runtime nodejs18.x \
            --handler dist/index.handler \
            --role ${{ secrets.AWS_LAMBDA_ROLE_ARN }} \
            --zip-file fileb://function.zip \
            --environment "Variables={DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }},CLIENT_ID=${{ secrets.CLIENT_ID }},TOKEN=${{ secrets.TOKEN }},SENTRY_DSN=${{ secrets.SENTRY_DSN }},NODE_ENV=production,COMMIT_SHA=${GITHUB_SHA},BUILD_NUMBER=${GITHUB_RUN_NUMBER}}" \
            --timeout 300 \
            --memory-size 128 \
            || true

      - name: Update Lambda function
        run: |
          # Update existing Lambda function
          aws lambda update-function-code \
            --function-name lukbot \
            --zip-file fileb://function.zip

          aws lambda update-function-configuration \
            --function-name lukbot \
            --environment "Variables={DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }},CLIENT_ID=${{ secrets.CLIENT_ID }},TOKEN=${{ secrets.TOKEN }},SENTRY_DSN=${{ secrets.SENTRY_DSN }},NODE_ENV=production,COMMIT_SHA=${GITHUB_SHA},BUILD_NUMBER=${GITHUB_RUN_NUMBER}}" \
            --timeout 300 \
            --memory-size 128

      - name: Set up EventBridge rule
        run: |
          # Create EventBridge rule if it doesn't exist
          aws events put-rule \
            --name lukbot-schedule \
            --schedule-expression "rate(1 hour)" \
            --state ENABLED \
            || true

          # Get the rule ARN
          RULE_ARN=$(aws events describe-rule --name lukbot-schedule --query 'Arn' --output text)

          # Add Lambda as target
          aws events put-targets \
            --rule lukbot-schedule \
            --targets "Id"="1","Arn"="arn:aws:lambda:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:function:lukbot"

      - name: Add Lambda permission for EventBridge
        run: |
          aws lambda add-permission \
            --function-name lukbot \
            --statement-id EventBridgeInvoke \
            --action lambda:InvokeFunction \
            --principal events.amazonaws.com \
            --source-arn "arn:aws:events:${{ env.AWS_REGION }}:${{ secrets.AWS_ACCOUNT_ID }}:rule/lukbot-schedule" \
            || true

      - name: Validate deployment
        run: |
          aws lambda get-function --function-name lukbot
          aws events describe-rule --name lukbot-schedule