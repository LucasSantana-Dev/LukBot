name: Deploy LukBot

on:
    push:
        branches: [main]
    workflow_dispatch: # Allow manual trigger

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check deploy secrets
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                  SSH_USER: ${{ secrets.SSH_USER }}
                  SSH_HOST: ${{ secrets.SSH_HOST }}
              run: |
                  missing=""
                  [ -z "$SSH_PRIVATE_KEY" ] && missing="SSH_PRIVATE_KEY "
                  [ -z "$SSH_USER" ] && missing="${missing}SSH_USER "
                  [ -z "$SSH_HOST" ] && missing="${missing}SSH_HOST"
                  if [ -n "$missing" ]; then
                    echo "::error::Missing GitHub Actions secrets: $missing"
                    echo "Add them in repo Settings → Secrets and variables → Actions. See docs/CI_CD.md (Deploy secrets)."
                    exit 1
                  fi

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.9.1
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Deploy to server
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
                    cd /home/luk-server/LukBot
                    
                    # Pull latest changes
                    echo "Pulling latest changes..."
                    git pull origin main
                    
                    # Build new Docker image
                    echo "Building new Docker image..."
                    docker build --target production-bot -t lukbot:latest .
                    
                    # Stop the current container
                    echo "Stopping current container..."
                    ./scripts/discord-bot.sh stop
                    
                    # Start the container with new image
                    echo "Starting container with new image..."
                    ./scripts/discord-bot.sh start
                    
                    # Wait a moment and check status
                    sleep 5
                    echo "Checking container status..."
                    ./scripts/discord-bot.sh status
                    
                    echo "Deployment completed!"
                  EOF

            - name: Notify deployment status
              if: always()
              run: |
                  if [ ${{ job.status }} == 'success' ]; then
                    echo "✅ Deployment successful!"
                  else
                    echo "❌ Deployment failed!"
                  fi
