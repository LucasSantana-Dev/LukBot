name: CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]  # Added PR validation

env:
  NODE_VERSION: '22.x'
  PM2_APP_NAME: 'lukbot'

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint code
        run: npm run lint
        
      - name: Run security audit
        run: npm audit --audit-level=high
        continue-on-error: true  # Don't fail the build, but report issues
        
      - name: Check for outdated dependencies
        run: npm outdated || true  # Just for information
      
  build:
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create version file
        run: |
          mkdir -p dist
          echo "{\n  \"version\": \"${GITHUB_SHA:0:7}\",\n  \"buildDate\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\",\n  \"buildNumber\": \"$GITHUB_RUN_NUMBER\",\n  \"branch\": \"${GITHUB_REF#refs/heads/}\"\n}" > version.json

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Copy version file to dist
        run: cp version.json dist/

      - name: Prepare deployment package
        run: |
          # Only include necessary files in the tarball
          tar --exclude='**/*.map' --exclude='**/test*' -czf bot.tar.gz dist package.json package-lock.json version.json ecosystem.config.cjs

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: bot-artifact
          path: |
            bot.tar.gz
            version.json

  deploy:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: bot-artifact

      - name: Write deploy script
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          # ... (your deploy script contents go here) ...
          EOF

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Create deployment directory on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/deployment"

      - name: Copy deployment package and scripts to EC2
        run: |
          scp -o StrictHostKeyChecking=no bot.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/
          scp -o StrictHostKeyChecking=no deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/deployment/

      - name: Generate .env file
        run: |
          cat > .env << EOF
          DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
          CLIENT_ID=${{ secrets.CLIENT_ID }}
          TOKEN=${{ secrets.TOKEN }}
          COMMAND_CATEGORIES_DISABLED=${{ env.COMMAND_CATEGORIES_DISABLED }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          LOG_LEVEL=${{ env.LOG_LEVEL }}
          NODE_ENV=production
          # Added for better error tracking
          COMMIT_SHA=${GITHUB_SHA}
          BUILD_NUMBER=${GITHUB_RUN_NUMBER}
          EOF

      - name: Copy .env to EC2
        run: |
          scp -o StrictHostKeyChecking=no .env ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/deployment/
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "chmod 600 ~/deployment/.env"

      - name: Run deploy script on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo '=== Running deploy script ==='
            # Clean up old app directory before unpacking
            rm -rf ~/app
            mkdir -p ~/app
            # Extract tarball with no-same-owner for speed and safety
            tar --no-same-owner -xzf ~/bot.tar.gz -C ~/app
            # Install production dependencies only if needed
            if [ -f ~/app/package.json ]; then
              cd ~/app
              NODE_ENV=production npm ci --omit=dev || true
            fi
            bash ~/deployment/deploy.sh > ~/deployment/deploy-log-$(date +%Y%m%d%H%M%S).log 2>&1 || { echo 'Deploy script failed! Check logs.'; exit 1; }
            echo "Exit code: $?"
            # Clean up old tarballs and scripts
            rm -f ~/bot.tar.gz ~/deployment/deploy.sh
            echo 'Cleaned up old tarballs and deploy script.'

      - name: Start/Restart bot with PM2 on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd ~/app
            echo 'Reloading application with PM2...'
            pm2 reload ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production
            pm2 save
            pm2 startup | tail -n 1 | bash || true
            pm2 list
            echo 'PM2 reload/start complete.'

      # (Optional) Slack/Discord notification step (uncomment and configure as needed)
      # - name: Notify Slack
      #   uses: rtCamp/action-slack-notify@v2
      #   env:
      #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      #     SLACK_MESSAGE: 'LukBot deployed successfully to EC2!'
      #     SLACK_COLOR: good
      #
      # - name: Notify Discord
      #   uses: Ilshidur/action-discord@master
      #   with:
      #     webhook: ${{ secrets.DISCORD_WEBHOOK }}
      #     message: 'LukBot deployed successfully to EC2!'

      - name: Validate deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            # Wait a moment for the process to stabilize
            sleep 5
            
            # Check if process is running
            if ! pm2 pid lukbot > /dev/null; then
              echo "Application failed to start!"
              pm2 logs lukbot --lines 50
              cat ~/deployment/deploy-log-*.log | tail -n 50
              exit 1
            fi
            
            # Display version info
            if [ -f ~/app/dist/version.json ]; then
              echo "=== Version Info ==="
              cat ~/app/dist/version.json
            fi
            
            echo "=== Process Status ==="
            pm2 show lukbot
            
            echo "=== System Resources ==="
            df -h | grep -v "tmpfs\|udev"
            free -m
            
            echo "=== Recent Logs ==="
            pm2 logs lukbot --lines 10
            
            echo "Deployment validation successful"